#include <SoftwareSerial.h>
#define RxD 2
#define TxD 3

#include <Wire.h>
#include <LiquidCrystal_I2C.h>
LiquidCrystal_I2C lcd(0x3F, 16, 2);

SoftwareSerial mySerial(RxD,TxD); // RX, TX

/* KY-013 ANALOG TEMPERATURE SENSOR MODULE */
double Thermister(int RawADC) {
  double Temp;
  Temp = log(((10240000/RawADC) - 10000));
  Temp = 1 / (0.001129148 + (0.000234125 + (0.0000000876741 * Temp * Temp ))* Temp );
  Temp = Temp - 273.15; // Convert Kelvin to Celcius
  return Temp;
}

/* -------------------------------------------*/

String SerialGET = "";
unsigned long previousMillis=0;
int interval=5000;
String r2mac;
void setup() {
    Serial.begin(9600);
    pinMode(RxD, INPUT);
    pinMode(TxD, OUTPUT);
    mySerial.begin(9600);
    lcd.begin();

    r2mac = String();
}
 
void loop() {
  
  unsigned long currentMillis = millis();
  delay(1000);
  if ((unsigned long)(currentMillis - previousMillis) >= interval) {
      String sensor = "ส่งค่า Sensor ของ R2";
      r2mac = String(21 + sensor);
      mySerial.print(r2mac);
      mySerial.print('\n');
      delay(2000);
      previousMillis = currentMillis;
   }

  

  /* KY-013 ANALOG TEMPERATURE SENSOR MODULE */
  /* Serial.print(Thermister(analogRead(0))); //read pin A0
   Serial.println("c");
   mySerial.print(Thermister(analogRead(0)));
   mySerial.println("c");
   delay(500);*/
 /*---------------------------------------------*/

  
    while (mySerial.available()) {                   //ฝั่งรับ    
        char incoming  = mySerial.read();
        SerialGET += incoming;
        if (incoming == '\n'){
          SerialGET.trim();             
          Serial.print("รับค่า :");
          Serial.println(SerialGET);
          if(SerialGET.substring(0,1) == "1" && SerialGET.substring(1,2) == "2") {
            Serial.println("ทำงาน");
            SerialGET = "";
          }
          if (SerialGET.substring(0,1) == "1"){  
           if(SerialGET.substring(1,2) == "1") {}
              else {
              SerialGET.setCharAt(0,'2');     // ส่งข้อมูลไป -->
              mySerial.print(SerialGET);
              mySerial.print('\n');
              Serial.print("ทำการส่งต่อแล้ว :");
              Serial.println(SerialGET);
              }
          }
          if (SerialGET.substring(0,1) == "3"){   
            if(SerialGET.substring(1,2) == "1"){
              SerialGET.setCharAt(0,'2');     // ส่งข้อมูลกลับ <--
              mySerial.print(SerialGET);
              mySerial.print('\n');
              Serial.print("ทำการส่งต่อแล้ว :");
              Serial.println(SerialGET);
              }
            }
SerialGET = "";
        }
        }
    if (Serial.available()){
        char incoming2 = Serial.read();
        mySerial.print(incoming2);
        
        }    


}
